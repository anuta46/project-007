{% extends "users/base.html" %}
{% load static %}

{% block title %}‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pt-10 pb-16">
  <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">

    {% with display_name=request.user.get_full_name|default:request.user.username %}
    <div class="relative overflow-hidden rounded-3xl p-8 bg-gradient-to-br from-indigo-600 via-purple-600 to-fuchsia-600 text-white shadow-2xl mb-12">
      <div class="absolute top-0 right-0 -mt-6 -mr-6 h-48 w-48 rounded-full bg-white/10 blur-3xl opacity-70"></div>

      <div class="relative flex items-center gap-6">
        <div class="h-16 w-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-xl">
          <i class="fa-solid fa-building text-white text-2xl"></i>
        </div>
        <div>
          <div class="text-3xl md:text-4xl font-extrabold mb-1">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì {{ display_name }} üëã</div>
          <p class="text-white/90 text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
        </div>
      </div>
    </div>
    {% endwith %}

    {# START: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß #}
    <div class="mb-10">
      <div class="w-full p-4 rounded-2xl shadow-xl bg-white/70 backdrop-blur-md border border-gray-100">
        <div class="flex items-center gap-3 mb-4 text-gray-800">
          <span class="inline-flex items-center justify-center h-8 w-8 rounded-lg bg-purple-500 text-white shadow-md">
            <i class="fa-solid fa-search text-sm"></i>
          </span>
          <span class="text-xl font-bold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</span>
        </div>

        <div class="relative w-full">
          <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ -->
          <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>

          <!-- ‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á -->
          <input
            type="text"
            id="searchOrg"
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å..."
            class="block w-full pl-11 pr-28 py-3.5 rounded-2xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition text-base"
            aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£"
          />

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á -->
          <div class="absolute inset-y-0 right-2 flex items-center gap-2">
            <button
              type="button"
              id="clearSearchBtn"
              class="inline-flex items-center justify-center h-9 w-9 rounded-xl border border-gray-300 bg-white text-gray-600 shadow-sm hover:bg-gray-100 transition"
              title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
              aria-label="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
            >
              <i class="fa-solid fa-rotate-right text-sm"></i>
            </button>
            <button
              type="button"
              id="triggerSearchBtn"
              class="inline-flex items-center justify-center px-4 h-9 rounded-xl bg-purple-600 text-white font-semibold shadow-lg hover:bg-purple-700 transition"
              title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
              aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
            >
              <i class="fa-solid fa-magnifying-glass mr-2 text-sm"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
          </div>
        </div>
      </div>
    </div>
    {# END: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß #}

    {% if orgs %}
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-6 text-gray-700">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <i class="fa-solid fa-building-circle-check text-indigo-600"></i>
          <span>‡∏û‡∏ö <span id="orgCount" class="font-semibold">{{ orgs|length }}</span> ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</span>
        </div>
      </div>

      <form method="post" id="pickOrgForm">
        {% csrf_token %}
        <div id="orgGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {% for org in orgs %}
            <label class="org-card group cursor-pointer"
                   data-org-name="{{ org.name|lower }}"
                   data-org-type="{{ org.business_type|lower|default:'' }}">
              <input type="radio" name="organization_id" value="{{ org.id }}" class="peer hidden" required>

              <div class="relative h-full bg-white rounded-2xl shadow-lg border-2 border-gray-100 peer-checked:border-purple-600 peer-checked:ring-4 peer-checked:ring-purple-200 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 overflow-hidden">
                <!-- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏°‡∏≤‡∏£‡πå‡∏Ñ -->
                <div class="absolute top-3 right-3 h-7 w-7 rounded-full bg-purple-600 text-white flex items-center justify-center opacity-0 peer-checked:opacity-100 transition-opacity shadow-lg z-10">
                  <i class="fa-solid fa-check text-sm"></i>
                </div>

                <div class="p-6 flex flex-col items-center text-center">
                  <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ / ‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠ -->
                  <div class="relative mb-4">
                    {% if org.logo %}
                      <img src="{{ org.logo.url }}" alt="{{ org.name }}"
                           class="h-24 w-24 object-cover rounded-2xl border-2 border-gray-100 shadow-md transition"
                           onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');" />
                      <div class="hidden h-24 w-24 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 text-white flex items-center justify-center text-3xl font-bold shadow-md">
                        {{ org.name|slice:":1"|upper }}
                      </div>
                    {% else %}
                      <div class="h-24 w-24 rounded-2xl bg-gradient-to-br from-purple-500 to-indigo-600 text-white flex items-center justify-center text-3xl font-bold shadow-md">
                        {{ org.name|slice:":1"|upper }}
                      </div>
                    {% endif %}
                  </div>

                  <div class="font-bold text-xl text-gray-900 mb-2 line-clamp-2">
                    {{ org.name }}
                  </div>

                  {% if org.business_type %}
                    <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-semibold">
                      <i class="fa-solid fa-tag text-[10px]"></i>
                      {{ org.business_type }}
                    </div>
                  {% endif %}
                </div>

                <!-- ‡πÅ‡∏ñ‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ -->
                <div class="h-1 bg-gradient-to-r from-purple-500 to-indigo-600 transform scale-x-0 group-hover:scale-x-100 peer-checked:scale-x-100 transition-transform origin-left"></div>
              </div>
            </label>
          {% endfor %}
        </div>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
        <div id="noResults" class="hidden text-center py-16">
          <div class="inline-flex items-center justify-center h-20 w-20 rounded-full bg-gray-200 mb-4">
            <i class="fa-solid fa-magnifying-glass-minus text-3xl text-gray-500"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
          <p class="text-gray-600">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥</p>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
        <div class="mt-12 flex justify-center">
          <button type="submit" id="submitButton" disabled
            class="group relative px-10 py-4 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold text-lg shadow-xl hover:shadow-2xl hover:scale-[1.02] transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
            <span class="flex items-center gap-3">
              <i class="fa-solid fa-arrow-right-to-bracket"></i>
              ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
              <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </span>
          </button>
        </div>
      </form>

    {% else %}
      <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ -->
      <div class="text-center py-20">
        <div class="inline-flex items-center justify-center h-24 w-24 rounded-full bg-gray-200 mb-6">
          <i class="fa-solid fa-building text-4xl text-gray-500"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</h3>
        <p class="text-gray-600 mb-6">‡∏´‡∏≤‡∏Å‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        <a href="{% url 'home' %}" class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition shadow-md">
          <i class="fa-solid fa-home"></i>
          ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
      </div>
    {% endif %}

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput  = document.getElementById('searchOrg');
  const orgCards     = document.querySelectorAll('.org-card');
  const orgCount     = document.getElementById('orgCount');
  const orgGrid      = document.getElementById('orgGrid');
  const noResults    = document.getElementById('noResults');
  const submitButton = document.getElementById('submitButton');
  const radioButtons = document.querySelectorAll('input[name="organization_id"]');

  const clearBtn  = document.getElementById('clearSearchBtn');
  const searchBtn = document.getElementById('triggerSearchBtn');

  // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
  const updateSubmitButtonState = () => {
    const isChecked = Array.from(radioButtons).some(radio => radio.checked);
    if (submitButton) submitButton.disabled = !isChecked;
  };
  updateSubmitButtonState();
  radioButtons.forEach(radio => radio.addEventListener('change', updateSubmitButtonState));

  // 2) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const applyFilter = () => {
    const searchTerm = (searchInput?.value || '').toLowerCase().trim();
    let visibleCount = 0;

    orgCards.forEach(card => {
      const orgName = card.dataset.orgName || '';
      const orgType = card.dataset.orgType || '';
      const isMatch = orgName.includes(searchTerm) || orgType.includes(searchTerm);

      if (isMatch) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    if (orgCount) orgCount.textContent = visibleCount;

    if (visibleCount === 0) {
      orgGrid?.classList.add('hidden');
      noResults?.classList.remove('hidden');
    } else {
      orgGrid?.classList.remove('hidden');
      noResults?.classList.add('hidden');
    }
  };

  // 3) ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏±‡∏ö‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
  if (searchInput) {
    searchInput.addEventListener('input', applyFilter);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyFilter();
      }
    });
  }

  if (searchBtn) {
    searchBtn.addEventListener('click', applyFilter);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (!searchInput) return;
      searchInput.value = '';
      searchInput.dispatchEvent(new Event('input'));
      searchInput.focus();
    });
  }
});
</script>
{% endblock %}
