<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Borrowing System{% endblock %}</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --sbw:18rem;
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --sidebar-gradient: linear-gradient(180deg, #1a1f2e 0%, #16213e 50%, #0f172a 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
    }
    * { box-sizing: border-box; }
    body{
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #2d3748;
      min-height: 100vh;
      display: flex;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.2) 0%, transparent 50%);
      pointer-events: none; z-index: -1;
    }

    /* Sidebar */
    .sidebar{
      position: fixed; z-index: 50; inset: 0 auto 0 0;
      width: var(--sbw); height: 100vh; overflow-y: auto;
      background: var(--sidebar-gradient); color: #e2e8f0;
      padding: 2rem 1.5rem;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05);
      transform: translateX(0);
      transition: all .4s cubic-bezier(.4,0,.2,1);
      backdrop-filter: blur(20px);
    }
    .sidebar::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(circle at 30% 20%, rgba(139,92,246,.3) 0%, transparent 50%),
                  radial-gradient(circle at 70% 80%, rgba(59,130,246,.2) 0%, transparent 50%);
      pointer-events: none; opacity: .8;
    }
    .sidebar > * { position: relative; z-index: 1; }
    .sidebar a, .sidebar button { color: #cbd5e1; transition: all .3s cubic-bezier(.4,0,.2,1); }
    .sidebar a:hover, .sidebar button:hover { color: #fff; transform: translateX(4px); }

    .nav-link{ position: relative; overflow: hidden; }
    .nav-link::before{
      content:''; position:absolute; inset:0 auto 0 -100%;
      width:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
      transition:left .6s;
    }
    .nav-link:hover::before{ left:100%; }
    .nav-link:hover{
      background: rgba(255,255,255,.08);
      border-left: 3px solid #60a5fa;
      box-shadow: 0 8px 32px rgba(59,130,246,.2);
    }
    .nav-active{
      background: rgba(255,255,255,.08)!important;
      border-left: 3px solid #60a5fa!important;
      color: #fff!important;
      box-shadow: 0 8px 32px rgba(59,130,246,.25)!important;
    }

    .content-area{ flex:1; margin-left: var(--sbw); transition: all .4s cubic-bezier(.4,0,.2,1); position: relative; }

    @media (max-width: 767px){
      .sidebar{ transform: translateX(-100%); box-shadow: none; }
      .sidebar.open{ transform: translateX(0); box-shadow: 0 25px 50px -12px rgba(0,0,0,.25); }
      .content-area{ margin-left: 0; }
    }

    .messages{ margin: 1.5rem 0; }
    .messages li{
      border-radius: 16px; padding: 1rem 1.5rem; margin: .75rem 0;
      border: 1px solid transparent; position: relative; overflow: hidden;
      backdrop-filter: blur(10px); animation: slideInFromTop .5s ease-out;
    }
    @keyframes slideInFromTop{ from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }
    .messages li::before{ content:''; position:absolute; top:0; left:0; width:4px; height:100%; transition:width .3s ease; }
    .messages li:hover::before{ width:8px; }
    .messages li.success{ background:linear-gradient(135deg,rgba(236,253,245,.9),rgba(209,250,229,.9)); color:#065f46; border-color:#34d399; box-shadow:0 10px 25px rgba(16,185,129,.2) }
    .messages li.success::before{ background:#10b981 }
    .messages li.error{ background:linear-gradient(135deg,rgba(254,226,226,.9),rgba(252,165,165,.9)); color:#991b1b; border-color:#f87171; box-shadow:0 10px 25px rgba(239,68,68,.2) }
    .messages li.error::before{ background:#ef4444 }
    .messages li.info{ background:linear-gradient(135deg,rgba(224,242,254,.9),rgba(147,197,253,.9)); color:#1e40af; border-color:#60a5fa; box-shadow:0 10px 25px rgba(59,130,246,.2) }
    .messages li.info::before{ background:#3b82f6 }

    .dropdown-content{
      display:none; position:absolute; right:0; top:calc(100% + .75rem);
      min-width:20rem; max-height:24rem; overflow:auto;
      background:rgba(255,255,255,.95); color:#374151;
      border:1px solid rgba(255,255,255,.3); border-radius:20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05);
      backdrop-filter: blur(20px); padding:.75rem; animation: dropdownFadeIn .3s ease-out; transform-origin: top right;
    }
    @keyframes dropdownFadeIn{ from{opacity:0;transform:scale(.95) translateY(-10px)} to{opacity:1;transform:scale(1) translateY(0)} }
    .dropdown-content.show{ display:block; }
    .dropdown-item{ display:block; padding:.875rem 1rem; border-radius:12px; color:#374151; text-decoration:none; transition:all .2s ease; position:relative; overflow:hidden; }
    .dropdown-item::before{ content:''; position:absolute; inset:0 auto 0 -100%; width:100%; background:linear-gradient(90deg,transparent,rgba(99,102,241,.1),transparent); transition:left .5s; }
    .dropdown-item:hover{ background:rgba(99,102,241,.08); transform:translateX(4px); box-shadow:0 4px 12px rgba(99,102,241,.15) }
    .dropdown-item:hover::before{ left:100% }
    .dropdown-item.unread{ background:linear-gradient(135deg,rgba(238,242,255,.8),rgba(224,231,255,.8)); border-left:3px solid #6366f1 }
    .dropdown-footer{ display:block; padding:.875rem 1rem; text-align:center; border-top:1px solid rgba(229,231,235,.5); margin-top:.5rem; }

    .topbar{ background:rgba(255,255,255,.8); backdrop-filter: blur(20px); border-bottom:1px solid rgba(255,255,255,.3); box-shadow:0 4px 32px rgba(0,0,0,.1) }
    .btn-primary{ background:var(--primary-gradient); color:#fff; border:none; padding:.75rem 1.5rem; border-radius:12px; font-weight:600; transition:all .3s ease; box-shadow:0 8px 25px rgba(102,126,234,.3) }
    .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 12px 35px rgba(102,126,234,.4) }

    .notification-badge{ background:linear-gradient(135deg,#ff6b6b,#ee5a52); box-shadow:0 0 20px rgba(255,107,107,.6); animation: pulse 2s infinite; }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }

    .sidebar::-webkit-scrollbar{ width:6px } 
    .sidebar::-webkit-scrollbar-track{ background:rgba(255,255,255,.1); border-radius:3px }
    .sidebar::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.3); border-radius:3px }
    .sidebar::-webkit-scrollbar-thumb:hover{ background:rgba(255,255,255,.5) }
  </style>
</head>

<body>
  <!-- Overlay (mobile) -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar flex flex-col">
    <!-- Brand -->
    <div class="flex items-center justify-between mb-8 pb-6 border-b border-white/20">
      <a href="{% url 'login' %}" class="text-2xl font-bold tracking-tight flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
          <i class="fa-solid fa-cubes text-white text-lg"></i>
        </div>
        <span class="text-white">ยืม-คืน</span>
      </a>
      <button id="sidebar-close-btn" class="md:hidden text-gray-400 hover:text-white transition-colors p-2 hover:bg-white/10 rounded-lg">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    {# แผงข้อมูลผู้ใช้ + องค์กร #}
    {% if user.is_authenticated %}
      {% comment %} <div class="rounded-2xl p-4 bg-white/5 border border-white/10 mb-6">
        <div class="flex items-center gap-3">
          {% if user.profile_image %}
            <img src="{{ user.profile_image.url }}" class="h-10 w-10 rounded-xl object-cover border border-white/20" alt="avatar">
          {% else %}
            <div class="h-10 w-10 rounded-xl bg-white/20 flex items-center justify-center font-bold text-white">
              {{ user.username|slice:":1"|upper }}
            </div>
          {% endif %}
          <div class="min-w-0">
            <div class="text-white font-semibold truncate">
              {{ user.get_full_name|default:user.username }}
            </div>
            <div class="text-xs text-gray-300/90 truncate">{{ user.email }}</div>
          </div> {% endcomment %}
        </div>

        {% comment %} <div class="mt-3 text-sm text-gray-200">
          {% if current_org %}
            <div class="opacity-90">องค์กรปัจจุบัน:</div>
            <div class="font-semibold truncate">{{ current_org.name }}</div>
          {% elif user.organization %}
            <div class="opacity-90">องค์กรประจำ:</div>
            <div class="font-semibold truncate">{{ user.organization.name }}</div>
          {% else %}
            <div class="opacity-90">ยังไม่ได้เลือกองค์กร</div>
            <a href="{% url 'pick_organization' %}" class="underline text-indigo-200 hover:text-white">เลือกองค์กร</a>
          {% endif %}
        </div> {% endcomment %}

        {% comment %} <div class="mt-3">
          {% if user.is_superuser %}
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-white/20 text-white">Superuser</span>
          {% elif user.is_org_admin %}
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-white/20 text-white">แอดมินองค์กร</span>
          {% else %}
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-white/20 text-white">ผู้ใช้ทั่วไป</span>
          {% endif %}
        </div>
      </div> {% endcomment %}
    {% endif %}

    <!-- Nav -->
    {% with current=request.resolver_match.url_name %}
    <nav class="flex flex-col gap-2 flex-grow">
      {% if user.is_authenticated %}

        {% if user.is_org_admin %}
          <a href="{% url 'dashboard' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'dashboard' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-400 to-indigo-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-chart-line text-white text-sm"></i>
            </div>
            <span class="font-medium">หน้าหลัก</span>
          </a>

          <a href="{% url 'item_overview' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'item_overview' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-emerald-400 to-emerald-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-boxes-stacked text-white text-sm"></i>
            </div>
            <span class="font-medium">รายการสิ่งของ</span>
          </a>

          <a href="{% url 'pending_loans_view' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'pending_loans_view' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-amber-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-hourglass-half text-white text-sm"></i>
            </div>
            <span class="font-medium">คำขอยืมที่รอดำเนินการ</span>
          </a>

          <a href="{% url 'active_loans_view' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'active_loans_view' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-rose-400 to-rose-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-hand-holding-heart text-white text-sm"></i>
            </div>
            <span class="font-medium">รายการยืมที่กำลังดำเนินการ</span>
          </a>

          <a href="{% url 'loan_history_admin_view' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'loan_history_admin_view' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-purple-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-clock-rotate-left text-white text-sm"></i>
            </div>
            <span class="font-medium">ประวัติการยืม</span>
          </a>

          <a href="{% url 'manage_organization_users' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'manage_organization_users' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-cyan-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-users-gear text-white text-sm"></i>
            </div>
            <span class="font-medium">จัดการผู้ใช้</span>
          </a>

        {% else %}
          <a href="{% url 'user_dashboard' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'user_dashboard' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-th-large text-white text-sm"></i>
            </div>
            <span class="font-medium">ยืม-คืน</span>
          </a>

          <a href="{% url 'pick_organization' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'pick_organization' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-400 to-indigo-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-building text-white text-sm"></i>
            </div>
            <span class="font-medium">เลือกองค์กร</span>
          </a>

          <a href="{% url 'my_borrowed_items_history' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'my_borrowed_items_history' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-green-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-book-open-reader text-white text-sm"></i>
            </div>
            <span class="font-medium">ประวัติการยืมของฉัน</span>
          </a>
        {% endif %}

        {% if user.is_superuser %}
          <a href="{% url 'superuser_dashboard' %}"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300 {% if current == 'superuser_dashboard' %}nav-active{% endif %}">
            <div class="w-8 h-8 bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-crown text-white text-sm"></i>
            </div>
            <span class="font-medium">Superuser Dashboard</span>
          </a>
          <a href="/admin/"
             class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300">
            <div class="w-8 h-8 bg-gradient-to-br from-gray-400 to-gray-500 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-screwdriver-wrench text-white text-sm"></i>
            </div>
            <span class="font-medium">Django Admin</span>
          </a>
        {% endif %}

      {% else %}
        <a href="{% url 'login' %}" class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300">
          <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-green-500 rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-right-to-bracket text-white text-sm"></i>
          </div>
          <span class="font-medium">เข้าสู่ระบบ</span>
        </a>
        <a href="{% url 'register_organization' %}" class="nav-link group flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-300">
          <div class="w-8 h-8 bg-gradient-to-br from-violet-400 to-violet-500 rounded-lg flex items-center justify-center">
            <i class="fa-solid fa-building text-white text-sm"></i>
          </div>
          <span class="font-medium">ลงทะเบียนองค์กร</span>
        </a>
      {% endif %}
    </nav>
    {% endwith %}

    {% if user.is_authenticated %}
      <form method="post" action="{% url 'logout' %}" class="mt-auto pt-6 border-t border-white/20">
        {% csrf_token %}
        <button type="submit" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-red-500/20 text-left text-red-400 hover:text-red-300 transition-all duration-300 group">
          <div class="w-8 h-8 bg-gradient-to-br from-red-400 to-red-500 rounded-lg flex items-center justify-center group-hover:scale-105 transition-transform">
            <i class="fa-solid fa-right-from-bracket fa-rotate-180 text-white text-sm"></i>
          </div>
          <span class="font-medium">ออกจากระบบ</span>
        </button>
      </form>
    {% endif %}

    <div class="mt-6 text-xs text-gray-400 text-center bg-white/5 rounded-lg p-3 backdrop-blur-sm">
      <i class="fa-solid fa-heart text-red-400"></i>
      © {% now "Y" %} Borrowing System
    </div>
  </aside>

  <!-- Content -->
  <div id="content-area" class="content-area">
    <!-- Topbar (mobile) -->
    <header class="topbar sticky top-0 z-30 md:hidden">
      <div class="flex items-center justify-between px-6 py-4">
        <button id="sidebar-open-btn" class="text-gray-700 hover:text-gray-900 p-2 hover:bg-white/20 rounded-lg transition-all">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <h1 class="text-lg font-semibold text-gray-800">
          {% block title_in_header %}{% endblock title_in_header %}
        </h1>
        <div class="relative">
          <button id="notification-bell-topbar" class="text-gray-700 hover:text-gray-900 p-2 hover:bg-white/20 rounded-lg transition-all">
            <i class="fa-solid fa-bell text-xl"></i>
            {% if unread_notifications_count > 0 %}
              <span class="notification-badge absolute -top-1 -right-1 text-white text-xs font-bold rounded-full h-4 min-w-[1rem] px-0.5 flex items-center justify-center text-center">
                {{ unread_notifications_count }}
              </span>
            {% endif %}
          </button>
          <div id="notification-dropdown-content-topbar" class="dropdown-content">
            {% if unread_notifications_count > 0 %}
              {% for notification in request.user.notifications.all|slice:":5" %}
                <a href="#" class="dropdown-item {% if not notification.is_read %}unread{% endif %}" data-notification-id="{{ notification.id }}">
                  <div class="font-medium">{{ notification.message }}</div>
                  <span class="block text-xs text-gray-500 mt-1">{{ notification.created_at|date:"M d, H:i" }}</span>
                </a>
              {% endfor %}
              <a href="{% url 'user_notifications' %}" class="dropdown-footer text-indigo-600 hover:text-indigo-800 font-medium hover:underline transition-colors">
                ดูทั้งหมด
              </a>
            {% else %}
              <div class="p-4 text-gray-600 text-center">
                <i class="fa-solid fa-bell-slash text-2xl mb-2 text-gray-400"></i>
                <div class="text-sm">ไม่มีการแจ้งเตือนใหม่</div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <!-- Container -->
    <div class="mx-auto max-w-7xl px-6 py-8">
      <div class="messages-container">
        {% if messages %}
          <ul class="messages">
            {% for message in messages %}
              <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                <div class="flex items-center gap-3">
                  {% if message.tags == 'success' %}
                    <i class="fa-solid fa-check-circle text-lg"></i>
                  {% elif message.tags == 'error' %}
                    <i class="fa-solid fa-exclamation-circle text-lg"></i>
                  {% elif message.tags == 'info' %}
                    <i class="fa-solid fa-info-circle text-lg"></i>
                  {% endif %}
                  <span>{{ message|safe }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <main>
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('sidebar-open-btn');
      const closeBtn = document.getElementById('sidebar-close-btn');
      const overlay = document.getElementById('sidebar-overlay');

      const openSidebar = () => { 
        sidebar.classList.add('open'); 
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      };
      const closeSidebar = () => { 
        sidebar.classList.remove('open'); 
        overlay.classList.add('hidden');
        document.body.style.overflow = '';
      };

      if (openBtn) openBtn.addEventListener('click', openSidebar);
      if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
      if (overlay) overlay.addEventListener('click', closeSidebar);

      function setupNotificationDropdown(bellId, contentId){
        const bell = document.getElementById(bellId);
        const box = document.getElementById(contentId);
        if(!bell || !box) return;

        bell.addEventListener('click', (e)=>{ 
          e.stopPropagation(); 
          box.classList.toggle('show');
        });

        window.addEventListener('click', (e)=>{
          if(!box.contains(e.target) && !bell.contains(e.target)){ 
            box.classList.remove('show');
          }
        });
      }

      setupNotificationDropdown('notification-bell-topbar', 'notification-dropdown-content-topbar');
    });
  </script>
</body>
</html>
