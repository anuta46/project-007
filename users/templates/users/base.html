<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Borrowing System{% endblock %}</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{--sbw:16rem}
    body{
      font-family:'Open Sans',sans-serif;
      background:#f7f7fb;
      color:#374151;
      min-height:100vh;
      display:flex;
    }
    /* Sidebar */
    .sidebar{
      position:fixed; z-index:50; inset:0 auto 0 0;
      width:var(--sbw); height:100vh; overflow-y:auto;
      background:#111827; /* gray-900 */
      color:#e5e7eb;      /* gray-200 */
      padding:1.25rem 1rem;
      box-shadow: 0 10px 15px -3px rgba(175, 157, 157, 0.2), 0 4px 6px -4px rgba(150, 144, 144, 0.2);
      transform:translateX(0); transition:transform .3s ease;
    }
    .sidebar a{ color:#cbd5e1 } /* gray-300 */
    .sidebar a:hover{ color:#fff }

    /* Content area */
    .content-area{
      flex:1; margin-left:var(--sbw);
      transition:margin-left .3s ease;
    }

    /* Mobile */
    @media (max-width: 767px){
      .sidebar{ transform:translateX(-100%) }
      .sidebar.open{ transform:translateX(0) }
      .content-area{ margin-left:0 }
    }

    /* Messages */
    .messages{ margin:1rem 0 }
    .messages li{ border-radius:.75rem; padding:.75rem 1rem; margin:.5rem 0; border:1px solid transparent }
    .messages li.success{ background:#ecfdf5; color:#065f46; border-color:#34d399 }
    .messages li.error{ background:#fee2e2; color:#991b1b; border-color:#f87171 }
    .messages li.info{ background:#e0f2fe; color:#1e40af; border-color:#60a5fa }

    /* Dropdown (notifications) */
    .dropdown-content{
      display:none; position:absolute; right:0; top:calc(100% + .5rem);
      min-width:18rem; max-height:22rem; overflow:auto;
      background:#fff; color:#5c4c4c;
      border:1px solid #e5e7eb; border-radius:.75rem;
      box-shadow:0 12px 30px rgba(0,0,0,.12);
      padding:.5rem;
    }
    .dropdown-content.show{ display:block }
    .dropdown-item{
      display:block; padding:.6rem .75rem; border-radius:.5rem; color:#374151; text-decoration:none
    }
    .dropdown-item:hover{ background:#f3f4f6 }
    .dropdown-item.unread{ background:#eef2ff } /* indigo-50 */
    .dropdown-footer{ display:block; padding:.6rem .75rem; text-align:center }

    /* Form baseline (optional, child pagesสามารถทับได้) */
    .form-field{ margin-bottom:1rem }
    .form-field label{ display:block; margin-bottom:.4rem; font-weight:600; color:#374151 }
    .form-field input,.form-field select,.form-field textarea{
      width:100%; border:1px solid #d1d5db; border-radius:.65rem;
      padding:.65rem .9rem; background:#fff; transition:border-color .2s, box-shadow .2s
    }
    .form-field input:focus,.form-field select:focus,.form-field textarea:focus{
      outline:none; border-color:#6366f1; box-shadow:0 0 0 4px rgba(185, 186, 226, 0.2)
    }
  </style>
</head>

<body>
  <!-- Overlay (mobile) -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

  <!-- Sidebar -->
  <!-- Sidebar -->
<aside id="sidebar" class="sidebar flex flex-col">
  <!-- Brand -->
  <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/10">
    <a href="{% url 'login' %}" class="text-white text-xl font-bold tracking-tight flex items-center gap-2">
      <i class="fa-solid fa-cubes text-indigo-400"></i> ยืม-คืน
    </a>
    <button id="sidebar-close-btn" class="md:hidden text-gray-400 hover:text-white">
      <i class="fa-solid fa-xmark text-xl"></i>
    </button>
  </div>

  <!-- Nav -->
  <nav class="flex flex-col gap-1 flex-grow">
    {% if user.is_authenticated %}
      {% if user.is_org_admin %}
        <a href="{% url 'dashboard' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-chart-line text-indigo-300 group-hover:text-white"></i>
          <span>หน้าหลัก</span>
        </a>
        <a href="{% url 'item_overview' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-boxes-stacked text-indigo-300 group-hover:text-white"></i>
          <span>รายการสิ่งของ</span>
        </a>
        <a href="{% url 'pending_loans_view' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-hourglass-half text-indigo-300 group-hover:text-white"></i>
          <span>คำขอยืมที่รอดำเนินการ</span>
        </a>
        <a href="{% url 'active_loans_view' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-hand-holding-heart text-indigo-300 group-hover:text-white"></i>
          <span>รายการยืมที่กำลังดำเนินการ</span>
        </a>
        <a href="{% url 'loan_history_admin_view' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-clock-rotate-left text-indigo-300 group-hover:text-white"></i>
          <span>ประวัติการยืม</span>
        </a>
        <a href="{% url 'manage_organization_users' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-users-gear text-indigo-300 group-hover:text-white"></i>
          <span>จัดการผู้ใช้</span>
        </a>
      {% else %}
        <a href="{% url 'user_dashboard' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 sidebar-link">
          <i class="fa-solid fa-th-large text-indigo-300 group-hover:text-white"></i>
          <span>ยืม-คืน</span>
        </a>
        <a href="{% url 'my_borrowed_items_history' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
          <i class="fa-solid fa-book-open-reader text-indigo-300 group-hover:text-white"></i>
          <span>ประวัติการยืมของฉัน</span>
        </a>
        <!-- แจ้งเตือน -->
        <div class="relative">
          <button id="notification-bell-sidebar" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
            <i class="fa-solid fa-bell text-indigo-300"></i>
            <span>แจ้งเตือน</span>
            {% if unread_notifications_count > 0 %}
              <span class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full h-5 min-w-[1.25rem] px-1.5 flex items-center justify-center">
                {{ unread_notifications_count }}
              </span>
            {% endif %}
          </button>
          <div id="notification-dropdown-content-sidebar" class="dropdown-content">
            {% if unread_notifications_count > 0 %}
              {% for notification in request.user.notifications.all|slice:":5" %}
                <a href="#" class="dropdown-item {% if not notification.is_read %}unread{% endif %}" data-notification-id="{{ notification.id }}">
                  {{ notification.message }}
                  <span class="block text-xs text-gray-500 mt-1">{{ notification.created_at|date:"M d, H:i" }}</span>
                </a>
              {% endfor %}
              <a href="{% url 'user_notifications' %}" class="dropdown-footer text-indigo-700 hover:underline">ดูทั้งหมด</a>
            {% else %}
              <div class="p-3 text-gray-600 text-center text-sm">ไม่มีการแจ้งเตือนใหม่</div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% else %}
      <a href="{% url 'login' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
        <i class="fa-solid fa-right-to-bracket text-indigo-300 group-hover:text-white"></i>
        <span>เข้าสู่ระบบ</span>
      </a>
      <a href="{% url 'register_organization' %}" class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5">
        <i class="fa-solid fa-building text-indigo-300 group-hover:text-white"></i>
        <span>ลงทะเบียนองค์กร</span>
      </a>
    {% endif %}
  </nav>

  {% if user.is_authenticated %}
  <!-- Logout ด้านล่างสุด -->
  <form method="post" action="{% url 'logout' %}" class="mt-auto pt-4 border-t border-white/10">
    {% csrf_token %}
    <button type="submit" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-600/20 text-left text-red-400 hover:text-red-300">
      <i class="fa-solid fa-right-from-bracket fa-rotate-180"></i>
      ออกจากระบบ
    </button>
  </form>
  {% endif %}

  <!-- Footer small -->
  <div class="mt-4 text-xs text-gray-400">
    © {{ now|date:"Y" }} Borrowing System
  </div>
</aside>


  <!-- Content -->
  <div id="content-area" class="content-area">
    <!-- Topbar (mobile) -->
    <header class="sticky top-0 z-30 md:hidden bg-white/80 backdrop-blur border-b border-gray-200">
      <div class="flex items-center justify-between px-4 py-3">
        <button id="sidebar-open-btn" class="text-gray-700">
          <i class="fa-solid fa-bars text-xl"></i>
        </button>
        <h1 class="text-base font-semibold text-gray-800">
          {% block title_in_header %}{% endblock title_in_header %}
        </h1>
        <div class="w-6"></div>
      </div>
    </header>

    <!-- Container -->
    <div class="mx-auto max-w-7xl px-4 py-6">
      <!-- Messages -->
      <div class="messages-container">
        {% if messages %}
          <ul class="messages">
            {% for message in messages %}
              <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message|safe }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <!-- Page content -->
      <main>
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('sidebar-open-btn');
      const closeBtn = document.getElementById('sidebar-close-btn');
      const overlay = document.getElementById('sidebar-overlay');

      const openSidebar = () => { sidebar.classList.add('open'); overlay.classList.remove('hidden'); };
      const closeSidebar = () => { sidebar.classList.remove('open'); overlay.classList.add('hidden'); };

      if (openBtn) openBtn.addEventListener('click', openSidebar);
      if (closeBtn) closeBtn.addEventListener('click', closeSidebar);
      if (overlay) overlay.addEventListener('click', closeSidebar);

      // Notification dropdown (sidebar)
      function setupNotificationDropdown(bellId, contentId){
        const bell = document.getElementById(bellId);
        const box  = document.getElementById(contentId);
        if(!bell || !box) return;

        bell.addEventListener('click', (e)=>{ e.stopPropagation(); box.classList.toggle('show'); });

        window.addEventListener('click', (e)=>{
          if(!box.contains(e.target) && !bell.contains(e.target)){ box.classList.remove('show'); }
        });

        // Mark read via fetch
        box.querySelectorAll('.dropdown-item').forEach(item=>{
          item.addEventListener('click', async (e)=>{
            e.preventDefault();
            const id = item.dataset.notificationId;
            const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            try{
              const res = await fetch(`/notifications/read/${id}/`,{
                method:'POST',
                headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'},
                body: JSON.stringify({})
              });
              if(res.ok){
                item.classList.remove('unread');
                const countSpan = bell.querySelector('span.bg-red-500');
                if(countSpan){
                  let n = parseInt(countSpan.textContent||'0')-1;
                  if(n>0) countSpan.textContent = n;
                  else countSpan.remove();
                }
              }
            }catch(err){ console.error(err); }
          });
        });
      }
      setupNotificationDropdown('notification-bell-sidebar','notification-dropdown-content-sidebar');

      // Smooth same-page anchor scroll for links having .sidebar-link
      document.querySelectorAll('.sidebar-link').forEach(link=>{
        link.addEventListener('click', (e)=>{
          const href = link.getAttribute('href');
          if(!href || !href.includes('#')) return; // normal navigate
          const [base, hash] = href.split('#');
          // If base path equals current path, smooth scroll instead of navigate
          try{
            const basePath = new URL(base, window.location.origin).pathname.replace(/\/$/,'');
            const herePath = window.location.pathname.replace(/\/$/,'');
            if(basePath === herePath){
              e.preventDefault();
              const target = document.getElementById(hash);
              if(target){
                target.scrollIntoView({behavior:'smooth', block:'start'});
                if(window.innerWidth < 768) closeSidebar();
              }
            }
          }catch{ /* ignore */ }
        });
      });
    });
  </script>
</body>
</html>
